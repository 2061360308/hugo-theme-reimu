{{ $levelStandard := .Get "levelStandard" | default "1000,5000,10000" }}

{{- $currentPath := .Page.File.Path -}}
{{- $articlesData := slice -}}
{{- $dateFormat := $.Site.Params.dateFormat | default "2006-01-02" -}}
{{- range where .Site.RegularPages "File.Path" "ne" $currentPath -}}
  {{ $rawContent := .RawContent }}
  {{ $postLinkCardPattern := `\{\{<\s*postLinkCard.*?>\}\}` }}
  {{ $heatMapCardPattern := `\{\{<\s*heatMapCard.*?>\}\}` }}

  {{ $step1 := replaceRE $postLinkCardPattern "" $rawContent }}
  {{ $cleanContent := replaceRE $heatMapCardPattern "" $step1 }}
  {{- $articlesData = $articlesData | append (dict
    "title" .Title
    "date" ( .Date | time.Format $dateFormat )
    "lastmod" ( .Lastmod | time.Format $dateFormat )
    "wordcount" ($cleanContent | $.Page.RenderString | string | countwords)
    )
  -}}
{{- end -}}


<div id="heatmap"></div>

<script>
const MONTH_NAMES = [
  "Jan",
  "Feb",
  "Mar",
  "Apr",
  "May",
  "Jun",
  "Jul",
  "Aug",
  "Sep",
  "Oct",
  "Nov",
  "Dec",
];

const pluralize = (num, word) => (`${num} ${word}${num <= 1 ? '' : 's'}`);

function getTooltip(contributionDay, contributionDate) {
  // 修正日期转换逻辑，确保日期一致
  const formattedDate = new Date(
    contributionDate.getTime() - contributionDate.getTimezoneOffset() * 60000,
  )
    .toISOString()
    .split("T")[0];

  if (contributionDay.count === 0) {
    return `No writing on ${formattedDate}`;
  }

  const postText = pluralize(contributionDay.post, "post");
  const wordText = pluralize(contributionDay.count, "word");

  return `${postText} ${wordText} on ${formattedDate}`;
}

function setStyle() {
  const styleText = `
    .outer-box {
      width: 100%;
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
    }

    .calendar-container  {
      display: grid;
      grid-template-columns: auto repeat(53, 10px);
      grid-template-rows: auto repeat(7, 10px) auto;
      gap: 3px;

      width: fit-content;
      font-size: 12px;
      padding: 14px;
      border: solid 1px #d1d9e0;
      border-radius: 0.375rem;
    }

    .month {
      grid-row: 1/2;
      margin-bottom: -3px;
    }

    .week {
      grid-row: 3;
      grid-column: 1/2;
      line-height: 10px;
      margin-right: 3px;
    }
    .week + .week {
      grid-row: 5;
    }
    .week + .week + .week {
      grid-row: 7;
    }

    .tiles {
      grid-column: 2/55;
      grid-row: 2/9;

      display: grid;
      grid-auto-flow: column;
      grid-template-columns: subgrid;
      grid-template-rows: subgrid;
    }

    .tile {
      display: block;
      width: 10px;
      height: 10px;
      border-radius: 2px;
      outline: 1px solid rgba(27, 35, 36, 0.06);
      outline-offset: -1px;
    }
    .tile[data-level="0"] {
      background: color-mix(in srgb, var(--red-0) 10%, white);
    }
    .tile[data-level="1"] {
      background: color-mix(in srgb, var(--red-0) 40%, white);
    }
    .tile[data-level="2"] {
      background: color-mix(in srgb, var(--red-0) 80%, white);
    }
    .tile[data-level="3"] {
      background: var(--red-0)
    }
    .tile[data-level="4"] {
      background: color-mix(in srgb, var(--red-0) 80%, black);
    }

    .total {
      grid-column: 2/30;
      grid-row: 9;
      margin-top: 4px;
    }

    .legend {
      grid-column: 30/53;
      grid-row: 9;
      margin-top: 4px;

      display: flex;
      gap: 5px;
      justify-content: right;
      align-items: center;
    }

    .year-select {
      height: 140px;
      padding: 5px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      justify-items: center;
      gap: 4px;
    }

    .year-option {
      padding: 5px 20px;
      border-radius: 0.375rem;
      cursor: pointer;
    }

    .year-option:hover {
      background-color: color-mix(in srgb, var(--red-0) 20%, white);
    }

    .year-option.active {
      background-color: color-mix(in srgb, var(--red-0) 50%, white);
    }


    @media screen and (max-width: 768px) {
      .year-select {
        width: 100%;
        height: auto;
        display: flex;
        flex-direction: row;
        justify-content: start;
        align-items: center;
      }

      .outer-box {
        flex-direction: column;
      }

      .inner-box {
        width: 100%;
        overflow-x: auto;
      }
    }
  `;
  const styleId = "calendar-style";
  let styleInserted = document.getElementById(styleId) !== null;
  if (!styleInserted) {
    const style = document.createElement("style");
    style.id = styleId;
    style.textContent = styleText;
    if (document.head.firstChild) {
      document.head.insertBefore(style, document.head.firstChild);
    } else {
      document.head.appendChild(style);
    }
  }
}

function createCalendar(selector, contributionData) {
  const element = document.querySelector(selector);

  element.innerHTML = `
    <div class="outer-box">
      <div class="year-select"></div>
      <div class="inner-box">
        <div class="calendar-container">
          ${["Mon", "Wed", "Fri"].map((t) => `<span class="week">${t}</span>`).join("")}
          <div class="legend">Less${new Array(5)
            .fill(0)
            .map((_, i) => `<i class="tile" data-level="${i}"></i>`)
            .join("")}More</div>
          <div class="tiles"></div>
        </div>
      </div>
    </div>
  `;

  const calendarContainer = element.querySelector(".calendar-container");
  const yearSelector = element.querySelector(".year-select");
  const tilesContainer = element.querySelector(".tiles");

  const allContributionData = completeContributionData(contributionData);
  const currentDisplayYear = new Date().getFullYear();

  yearSelector.innerHTML = Object.keys(allContributionData)
    .sort((a, b) => b - a)
    .map(
      (year) =>
        `<div class="year-option ${year == currentDisplayYear ? "active" : ""}">${year}</div>`,
    )
    .join("");

  yearSelector.addEventListener("click", ({ target }) => {
    if (target.classList.contains("year-option")) {
      document.querySelector(".active")?.classList.remove("active");
      target.classList.add("active");
      generateYearContributions(target.textContent);
    }
  });

  const generateYearContributions = (year) => {
    tilesContainer.innerHTML = "";
    calendarContainer.querySelectorAll(".month").forEach((m) => m.remove());
    calendarContainer.querySelectorAll(".total").forEach((t) => t.remove());
    const data = allContributionData[year];
    const startRow = new Date(data[0].date).getDay();
    let latestMonth = -1;

    const monthFragment = document.createDocumentFragment();
    const tilesFragment = document.createDocumentFragment();

    const [tiles, totalStatistical] = data.reduce(
      ([tiles, stats], c, i) => {
        const date = new Date(c.date);
        const month = date.getMonth();

        // 统计逻辑
        stats.count += c.count;
        stats.post += c.post;

        // 处理月份标签
        if (date.getDay() === 0 && month !== latestMonth) {
          const gridColumn = 2 + Math.floor((i + startRow) / 7);
          latestMonth = month;
          const monthLabel = document.createElement("span");
          monthLabel.className = "month";
          monthLabel.textContent = MONTH_NAMES[month];
          monthLabel.style.gridColumn = gridColumn;
          monthFragment.append(monthLabel);
        }
        // 创建日历格子
        const tile = document.createElement("i");
        tile.className = "tile";
        tile.dataset.level = c.level;
        tile.title = getTooltip(c, date);
        tiles.push(tile);
        return [tiles, stats];
      },
      [[], { count: 0, post: 0 }],
    );

    // 处理首格位置
    if (tiles[0]) {
      tiles[0].style.gridRow = startRow + 1;
    }

    tilesFragment.append(...tiles);

    calendarContainer.append(monthFragment);
    tilesContainer.append(tilesFragment);

    calendarContainer.insertAdjacentHTML(
      "beforeend",
      `<div class="total">${pluralize(totalStatistical.post, "post")} ${pluralize(totalStatistical.count, "word")} in ${year}</div>`,
    );
  };

  // 初始化显示当前年份的日历
  generateYearContributions(currentDisplayYear);

  // 添加样式
  setStyle();
}

function completeContributionData(userData) {
  // 对用户数据按日期排序
  userData.sort((a, b) => a.date - b.date);

  // 获取起始日期和当前日期
  const startDate = new Date(userData[0].date);
  const currentDate = new Date();

  // 初始化结果数组
  const allData = {};
  // 创建映射表
  const userDataMap = {};
  userData.forEach((data) => {
    const dataDate = new Date(data.date);
    const key = `${dataDate.getFullYear()}-${dataDate.getMonth()}-${dataDate.getDate()}`;
    userDataMap[key] = data;
  });

  // 遍历年份
  for (
    let year = startDate.getFullYear();
    year <= currentDate.getFullYear();
    year++
  ) {
    const [startYear, endYear] =
      year === currentDate.getFullYear()
        ? [
            new Date(
              new Date(currentDate).setDate(currentDate.getDate() - 365),
            ),
            new Date(currentDate.getTime() + 86400000),
          ]
        : [new Date(year, 0, 1), new Date(year + 1, 0, 1)];

    const yearData = [];
    for (let d = startYear; d < endYear; d.setDate(d.getDate() + 1)) {
      const key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
      yearData.push(
        userDataMap[key] || {
          level: 0,
          date: d.getTime(),
          count: 0,
          post: 0,
        },
      );
    }
    allData[year] = yearData;
  }
  return allData;
}

// 获取日期数据
const articleStats = {{ $articlesData }};

function getLevelFromWordCount(totalCount) {
  const levelStandard = {{ $levelStandard }}.split(",").map(Number);
  if (totalCount <= 0) return 0;
  if (totalCount <= levelStandard[0]) return 1;
  if (totalCount <= levelStandard[1]) return 2;
  if (totalCount <= levelStandard[2]) return 3;
  return 4;
}

function transformArticlesData(articlesData) {
  const dailyStats = articlesData.reduce((map, { date, wordcount }) => {
    const entry = map.get(date) ?? { count: 0, post: 0 };
    return map.set(date, {
      count: entry.count + wordcount,
      post: entry.post + 1,
    });
  }, new Map());

  return Array.from(dailyStats, ([dayStr, { count, post }]) => ({
    level: getLevelFromWordCount(count),
    date: new Date(dayStr).getTime(),
    count,
    post,
  }));
}

createCalendar("#heatmap", transformArticlesData(articleStats));

</script>
