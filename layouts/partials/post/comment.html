{{ $site := .Site }}
{{ $params := .Site.Params }}
{{ $js := .Site.Data.vendor.js }}

{{ if and (not (eq .Params.comments false)) $params.comment.enable }}
<script>
  var commentEnable = {{ if and $params.comment.enable }}true{{ else }}false{{ end }};
  var valineEnable = {{ if and $params.valine.enable $params.valine.appId $params.valine.appKey }}true{{ else }}false{{ end }};
  var walineEnable = {{ if and $params.waline.enable $params.waline.serverURL }}true{{ else }}false{{ end }};
  var twikooEnable = {{ if and $params.twikoo.enable $params.twikoo.envId }}true{{ else }}false{{ end }};
  var gitalkEnable = {{ if and $params.gitalk.enable $params.gitalk.clientID $params.gitalk.clientSecret }}true{{ else }}false{{ end }};
  var giscusEnable = {{ if and $params.giscus.enable }}true{{ else }}false{{ end }};

  /* 获取默认评论系统 */

  var defaultComment = '';
  if (commentEnable) {
    // 1. 首先检查localStorage中是否有保存的评论类型
    var savedCommentType = localStorage.getItem('commentType');
    
    // 2. 如果localStorage中有值且对应的评论系统可用，就使用它
    if (savedCommentType) {
      var isValid = (
        (savedCommentType === 'valine' && valineEnable) ||
        (savedCommentType === 'waline' && walineEnable) ||
        (savedCommentType === 'twikoo' && twikooEnable) ||
        (savedCommentType === 'gitalk' && gitalkEnable) ||
        (savedCommentType === 'giscus' && giscusEnable)
      );
      
      if (isValid) {
        defaultComment = savedCommentType;
      }
    }
    
    // 3. 如果localStorage无效，检查配置的默认评论系统
    if (!defaultComment) {
      var configDefault = '{{ $params.comment.default }}';
      var isConfigValid = (
        (configDefault === 'valine' && valineEnable) ||
        (configDefault === 'waline' && walineEnable) ||
        (configDefault === 'twikoo' && twikooEnable) ||
        (configDefault === 'gitalk' && gitalkEnable) ||
        (configDefault === 'giscus' && giscusEnable)
      );
      
      if (isConfigValid) {
        defaultComment = configDefault;
      }
    }
    
    // 4. 如果前两项都无效，按指定顺序找到第一个可用的评论系统
    if (!defaultComment) {
      if (valineEnable) {
        defaultComment = 'valine';
      } else if (walineEnable) {
        defaultComment = 'waline';
      } else if (twikooEnable) {
        defaultComment = 'twikoo';
      } else if (gitalkEnable) {
        defaultComment = 'gitalk';
      } else if (giscusEnable) {
        defaultComment = 'giscus';
      }
    }
  }

  if (walineEnable) {
    var walinePath = '{{ $params.waline.serverURL }}';
    var walineLocale = JSON.parse({{ $params.waline.locale | jsonify }});
    var walineEmoji = JSON.parse({{ $params.waline.emoji | jsonify }});
    var walineMeta = JSON.parse({{ $params.waline.meta | jsonify }});
    var walineRequiredMeta = JSON.parse({{ $params.waline.requiredMeta | jsonify }});
    var walineWordLimit = {{ $params.waline.wordLimit }};
    var walinePageSize = {{ $params.waline.pageSize }};
    var walinePageview = {{ $params.waline.pageview }};
  }

  if (gitalkEnable) {
    var gitalkMd5 = {{ $params.gitalk.md5 }};
    if (gitalkMd5) {
      var gitalkMd5 = window.md5 ? window.md5(location.pathname) : location.pathname
    } else {
      location.pathname;
    }
    var gitalkAdmin = JSON.parse({{ $params.gitalk.admin | jsonify }});
  }
</script>
{{ end }}

{{ if and (not (eq .Params.comments false)) $params.comment.enable }}
<script data-pjax>
  const loadComments = () => {
    if (!commentEnable) return;
    // 评论组件加载状态跟踪
    const loadedComments = {
      valine: false,
      waline: false,
      twikoo: false,
      gitalk: false,
      giscus: false
    };

    // 隐藏所有评论容器
    const hideAllComments = () => {
      const commentContainers = document.querySelectorAll('.comment');
      commentContainers.forEach(container => {
        container.style.display = 'none';
      });
    };

    // 按需加载评论系统
    const loadCommentSystem = (type) => {
      if (loadedComments[type]) {
        // 如果已加载，只需显示对应容器
        document.querySelector(`.${type}-comment`).style.display = 'block';
        return;
      }

      // 根据类型加载对应的脚本
      switch (type) {
        case 'valine':
          if (valineEnable) loadValine();
          break;
        case 'waline':
          if (walineEnable) loadWaline();
          break;
        case 'twikoo':
          if (twikooEnable) loadTwikoo();
          break;
        case 'gitalk':
          if (gitalkEnable) loadGitalk();
          break;
        case 'giscus':
          if (giscusEnable) loadGiscus();
          break;
      }

      loadedComments[type] = true;
    };

    // 评论组件选择器
    const changeActiveCommentItems = (item) => {
      const commentItems = document.querySelectorAll('.selector-item');
      for (let i = 0; i < commentItems.length; i++) {
        commentItems[i].classList.remove('active');
      }
      item.classList.add('active');

      // 获取要加载的评论系统类型
      const commentType = item.getAttribute('data-selector');

      // 隐藏所有评论系统
      hideAllComments();

      // 加载选中的评论系统
      loadCommentSystem(commentType);
    };

    document.addEventListener('DOMContentLoaded', function () {
      // 评论组件选择器点击事件
      const commentItems = document.querySelectorAll('.selector-item');

      for (let item of commentItems) {
        item.addEventListener('click', function () {
          // 保存选择器状态
          const commentType = item.getAttribute('data-selector');
          window.localStorage.setItem('commentType', commentType);
          // 切换选中状态
          changeActiveCommentItems(item);
        });
      }

      // 检查是否需要加载默认评论系统
      if (defaultComment) {
        const defaultSelectorItem = document.querySelector(`[data-selector="${defaultComment}"]`);
        if (!defaultSelectorItem) return;
        defaultSelectorItem.style.display = 'block';
        defaultSelectorItem.classList.add('active');
        loadCommentSystem(defaultComment);
      }
    });
  };

  /* 各评论系统的加载函数 */

  function loadValine() {
    const container = document.querySelector('.valine-comment');
    if (!container) return;
    container.style.display = 'block';

    // 加载 Valine 脚本
    const script = document.createElement('script');
    script.src = '{{ index (partial "helpers/vendorCdn.html" (dict "item" $js.valine "ctx" $site)) 0 }}';
    script.integrity = '{{ index (partial "helpers/vendorCdnIntegrity.html" (dict "item" $js.valine)) 0 }}';
    script.crossOrigin = 'anonymous';
    script.onload = function () {
      const GUEST_INFO = ['nick', 'mail', 'link'];
      const guest_info = '{{ $params.valine.guest_info }}'.split(',').filter((item) => {
        return GUEST_INFO.indexOf(item) > -1
      });
      const recordIP = JSON.parse('{{ $params.valine.recordIP }}');
      const highlight = JSON.parse('{{ $params.valine.highlight }}');
      const visitor = JSON.parse('{{ $params.valine.visitor }}');

      new Valine({
        el: '.valine-comment',
        appId: "{{ $params.valine.appId }}",
        appKey: "{{ $params.valine.appKey }}",
        placeholder: "{{ $params.valine.placeholder }}",
        pageSize: '{{ $params.valine.pageSize }}',
        avatar: '{{ $params.valine.avatar }}',
        lang: '{{ $params.valine.lang }}',
        recordIP: recordIP,
        highlight: highlight,
        visitor: visitor,
        requiredFields: guest_info,
        path: window.location.pathname
      });
    };
    document.head.appendChild(script);
  }

  async function loadWaline() {
    const container = document.querySelector('.waline-comment');
    if (!container) return;
    container.style.display = 'block';

    // 使用模块方式加载 Waline
    const { init } = await safeImport('{{ index (partial "helpers/vendorCdn.html" (dict "item" $js.waline "ctx" $site)) 0 }}', '{{ index (partial "helpers/vendorCdnIntegrity.html" (dict "item" $js.waline "ctx" $site)) 0 }}');
    window.walineInstance = init({
      el: '.waline-comment',
      serverURL: '{{ $params.waline.serverURL }}',
      lang: '{{ $params.waline.lang }}',
      locale: walineLocale,
      emoji: walineEmoji,
      meta: walineMeta,
      requiredMeta: walineRequiredMeta,
      wordLimit: walineWordLimit,
      comment: true,
      pageSize: walinePageSize,
      dark: 'html[data-theme="dark"]',
      pageview: walinePageview,
    });
  }

  function loadTwikoo() {
    const container = document.querySelector('.twikoo-comment');
    if (!container) return;
    container.style.display = 'block';

    // 加载 Twikoo 脚本
    const script = document.createElement('script');
    script.src = '{{ index (partial "helpers/vendorCdn.html" (dict "item" $js.twikoo "ctx" $site)) 0 }}';
    script.integrity = '{{ index (partial "helpers/vendorCdnIntegrity.html" (dict "item" $js.twikoo)) 0 }}';
    script.crossOrigin = 'anonymous';
    script.onload = function () {
      twikoo.init({
        envId: '{{ $params.twikoo.envId }}',
        el: '.twikoo-comment',
        region: '{{ $params.twikoo.region }}',
      });
    };
    document.head.appendChild(script);
  }

  function loadGitalk() {
    const container = document.querySelector('.gitalk-comment');
    if (!container) return;
    container.style.display = 'block';

    // 加载 Gitalk 脚本
    const script = document.createElement('script');
    script.src = '{{ index (partial "helpers/vendorCdn.html" (dict "item" $js.gitalk "ctx" $site)) 0 }}';
    script.integrity = '{{ index (partial "helpers/vendorCdnIntegrity.html" (dict "item" $js.gitalk)) 0 }}';
    script.crossOrigin = 'anonymous';
    script.onload = function () {

      if (gitalkMd5) {
        // 如果需要 md5，加载 md5 脚本
        const md5Script = document.createElement('script');
        md5Script.src = '{{ index (partial "helpers/vendorCdn.html" (dict "item" $js.md5 "ctx" $site)) 0 }}';
        md5Script.integrity = '{{ index (partial "helpers/vendorCdnIntegrity.html" (dict "item" $js.md5)) 0 }}';
        md5Script.crossOrigin = 'anonymous';
        md5Script.onload = initGitalk;
        document.head.appendChild(md5Script);
      } else {
        // 否则直接初始化 Gitalk
        initGitalk();
      }
    };
    document.head.appendChild(script);

    function initGitalk() {
      let gitalk = new Gitalk({
        clientID: '{{ $params.gitalk.clientID }}',
        clientSecret: '{{ $params.gitalk.clientSecret}}',
        repo: '{{ $params.gitalk.repo }}',
        owner: '{{ $params.gitalk.owner }}',
        admin: gitalkAdmin,
        id: gitalkId,
        distractionFreeMode: false
      });
      gitalk.render('comments');
    }
  }

  function loadGiscus() {
    const container = document.querySelector('.giscus-comment');
    if (!container) return;
    container.style.display = 'block';

    // 删除可能已存在的 giscus 脚本和 iframe
    const existingScript = container.querySelector('script[src*="giscus.app/client.js"]');
    if (existingScript) existingScript.remove();
    const existingFrame = document.querySelector('iframe.giscus-frame');
    if (existingFrame) existingFrame.remove();

    // 加载 Giscus 脚本
    const giscusScript = document.createElement('script');
    const domMode = document.documentElement.getAttribute("data-theme");
    giscusScript.src = 'https://giscus.app/client.js';
    giscusScript.setAttribute('data-repo', '{{ $params.giscus.repo }}');
    giscusScript.setAttribute('data-repo-id', '{{ $params.giscus.repoId }}');
    giscusScript.setAttribute('data-category', '{{ $params.giscus.category }}');
    giscusScript.setAttribute('data-category-id', '{{ $params.giscus.categoryId }}');
    giscusScript.setAttribute('data-mapping', '{{ $params.giscus.strict }}');
    giscusScript.setAttribute('data-strict', '{{ $params.giscus.strict }}');
    giscusScript.setAttribute('data-reactions-enabled', '{{ $params.giscus.reactionsEnabled }}');
    giscusScript.setAttribute('data-emit-metadata', '{{ $params.giscus.emitMetadata }}');
    giscusScript.setAttribute('data-input-position', '{{ $params.giscus.inputPosition }}');
    giscusScript.setAttribute('data-theme', domMode === 'dark' ? 'dark' : 'light');
    giscusScript.setAttribute('data-lang', '{{ $params.giscus.lang }}');
    giscusScript.setAttribute('crossorigin', 'anonymous');
    giscusScript.async = true;
    container.appendChild(giscusScript);
    document.body.addEventListener('light-theme-set', () => {
      const iframe = document.querySelector('iframe.giscus-frame');
      if (!iframe) return;
      iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: 'light' } } }, 'https://giscus.app');
    });
    document.body.addEventListener('dark-theme-set', () => {
      const iframe = document.querySelector('iframe.giscus-frame');
      if (!iframe) return;
      iframe.contentWindow.postMessage({ giscus: { setConfig: { theme: 'dark' } } }, 'https://giscus.app');
    });
  }

  loadComments();
</script>
{{ end }}